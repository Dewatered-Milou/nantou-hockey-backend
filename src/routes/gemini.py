from flask import Blueprint, request, jsonify
import os
import json
import requests
from datetime import datetime

gemini_bp = Blueprint('gemini', __name__)


API_KEY = os.getenv("GEMINI_API_KEY")
MODEL = os.getenv("GEMINI_MODEL", "gemini-2.5-flash")

if not API_KEY:
    # å•Ÿå‹•æœŸå°±ä¸­æ­¢ï¼Œé¿å…ç·šä¸Šæ‰ 500
    raise RuntimeError("GEMINI_API_KEY is not set. Please set it in environment variables.")

API_URL = f"https://generativelanguage.googleapis.com/v1beta/models/{MODEL}:generateContent?key={API_KEY}"


CONTEXT = """
# 2025 å—æŠ•åœ‹éš›æ›²æ£çƒé‚€è«‹è³½ - AI å®¢æœåƒè€ƒè³‡æ–™

## [åŸºæœ¬è³‡è¨Š]
- **è³½äº‹åç¨±**: 2025 å—æŠ•åœ‹éš›æ›²æ£çƒé‚€è«‹è³½
- **æ ¸å¿ƒå®šä½**: çµåˆé‹å‹•ã€ç§‘æŠ€èˆ‡è§€å…‰çš„åœ‹éš›ç´šè³½äº‹ã€‚

## [è³½äº‹è³‡è¨Š]
- **æ¯”è³½æ—¥æœŸ**: 2025å¹´7æœˆ26æ—¥ (é€±å…­) è‡³ 7æœˆ31æ—¥ (é€±å››)ï¼Œå…±6å¤©ã€‚
- **æ¯æ—¥æ¯”è³½æ™‚é–“**: 09:00 è‡³ 18:00ã€‚
- **è©³ç´°è³½ç¨‹**:
  - 7/26 (å…­): é–‹å¹•å…¸ç¦® + é¦–è¼ªæ¯”è³½
  - 7/27 (æ—¥): å°çµ„è³½ç¬¬äºŒè¼ª
  - 7/28 (ä¸€): å°çµ„è³½ç¬¬ä¸‰è¼ª
  - 7/29 (äºŒ): æº–æ±ºè³½
  - 7/30 (ä¸‰): å­£è»è³½ + å† è»è³½
  - 7/31 (å››): é–‰å¹•å…¸ç¦® + é ’ç
- **æ¯”è³½åœ°é»**:
  - **å ´åœ°**: å—æŠ•ç¸£ç«¹å±±é«˜ä¸­æ›²æ£çƒå ´
  - **åœ°å€**: å—æŠ•ç¸£ç«¹å±±é®
  - **å ´åœ°ç‰¹è‰²**: FIHåœ‹éš›èªè­‰å ´åœ°ï¼Œ1000å¸­è§€çœ¾åº§ä½ï¼ŒLEDå¤§è¢å¹•ï¼ŒARæ–‡åŒ–é«”é©—å€ã€‚
- **åƒè³½éšŠä¼**: å…±æœ‰5å€‹åœ‹å®¶6æ”¯éšŠä¼ï¼ŒåŒ…æ‹¬ä¸­è¯å°åŒ—ã€æ—¥æœ¬ã€éŸ“åœ‹ã€é¦¬ä¾†è¥¿äºã€æ–°åŠ å¡ã€æ³°åœ‹ã€‚

## [äº¤é€šè³‡è¨Š]
- **è‡ªè¡Œé–‹è»Š**: åœ‹é“3è™Ÿç«¹å±±äº¤æµé“ã€‚
- **å¤§çœ¾é‹è¼¸**: æ­ä¹˜é«˜éµè‡³å°ä¸­ç«™ï¼Œè½‰ä¹˜å®˜æ–¹æ¥é§è»Šã€‚
- **åœè»Šè³‡è¨Š**: è³¼è²·ã€Œç²¾ç·»ç¥¨ã€æˆ–æ›´é«˜ç­‰ç´šçš„ç¥¨ç¨®ï¼Œå¯äº«å…è²»åœè»Šã€‚

## [è³¼ç¥¨è³‡è¨Š]
- **ç¥¨ç¨®èˆ‡åƒ¹æ ¼**:
  - **ä¸€èˆ¬ç¥¨**: NT$500
  - **ç²¾ç·»ç¥¨**: NT$1,200 (åŒ…å« AR é«”é©—)
  - **VIPç¥¨**: NT$2,500 (åŒ…å«å…ƒå®‡å®™è§€è³½é«”é©—)
  - **å®¶åº­å¥—ç¥¨**: NT$1,800 (é©ç”¨4äºº)
- **è³¼ç¥¨æ–¹å¼**:
  - **ç·šä¸Šè³¼ç¥¨**: é€éå®˜æ–¹ç¶²ç«™çš„è³¼ç¥¨ç³»çµ±ã€‚
  - **é›»è©±è³¼ç¥¨**: æ’¥æ‰“ 049-123-4567ã€‚
  - **ç¾å ´è³¼ç¥¨**: å‰å¾€ç«¹å±±é«˜ä¸­å”®ç¥¨è™•ã€‚
- **é€€ç¥¨æ”¿ç­–**:
  - è³½äº‹å‰7å¤©: å¯å…¨é¡é€€ç¥¨ã€‚
  - è³½äº‹å‰3-7å¤©: é€€ç¥¨éœ€æ”¶å–10%æ‰‹çºŒè²»ã€‚
  - è³½äº‹3å¤©å…§: æ•ä¸æ¥å—é€€ç¥¨ã€‚

## [è§€å…‰å¥—ç¥¨è³‡è¨Š]
- **æ—¥æœˆæ½­æ¹–å…‰å±±è‰²è§€è³½ä¹‹æ—…**:
  - **åƒ¹æ ¼**: NT$3,999
  - **å…§å®¹**: 2å¤©1å¤œä½å®¿ï¼Œè³½äº‹é–€ç¥¨ï¼Œæ—¥æœˆæ½­éŠæ¹–ï¼Œçºœè»Šé«”é©—ï¼ŒARé‚µæ—æ–‡åŒ–é«”é©—ã€‚
- **æ¸…å¢ƒé«˜å±±è§€è³½å¥—ç¥¨**:
  - **åƒ¹æ ¼**: NT$4,599
  - **å…§å®¹**: 3å¤©2å¤œä½å®¿ï¼Œè³½äº‹é–€ç¥¨ï¼Œæ¸…å¢ƒè¾²å ´ï¼Œåˆæ­¡å±±æ—¥å‡ºï¼Œé«˜å±±æ°‘å®¿ã€‚
- **VIPé ‚ç´šè§€è³½é«”é©—**:
  - **åƒ¹æ ¼**: NT$8,999
  - **å…§å®¹**: 3å¤©2å¤œä½å®¿ï¼ŒVIPåº§ä½é–€ç¥¨ï¼Œäº”æ˜Ÿç´šé£¯åº—ï¼Œç±³å…¶æ—é¤å»³ï¼Œå…ƒå®‡å®™è§€è³½é«”é©—ã€‚

## [é‹å‹•ç§‘æŠ€äº®é»]
- **AIæ™ºæ…§è£åˆ¤ç³»çµ±**: å¤šæ©Ÿä½é«˜é€Ÿæ”å½±ï¼Œå³æ™‚åˆ¤ç½°è¼”åŠ©ï¼Œé·¹çœ¼ç´šå›æ”¾ã€‚
- **æ•¸æ“šåˆ†æå¹³å°**: GPSç©¿æˆ´è£ç½®ç›£æ¸¬ï¼Œç”Ÿç‰©åŠ›å­¸åˆ†æï¼Œå³æ™‚æ•¸æ“šè¦–è¦ºåŒ–ã€‚
- **å…ƒå®‡å®™è§€è³½é«”é©—**: 360åº¦è™›æ“¬è§€è³½ï¼Œæ•¸ä½å­¿ç”ŸæŠ€è¡“ï¼Œäº’å‹•å¼æ•¸æ“šæŸ¥çœ‹ã€‚
- **ARæ–‡åŒ–é«”é©—**: å¸ƒè¾²æ—åœ–é¨°å‹•ç•«ï¼Œæ—¥æœˆæ½­å‚³èªªå°è¦½ï¼Œç«¹å±±ç«¹è—å·¥åŠã€‚

## [éšŠä¼å ±åè³‡è¨Š]
- **å ±åè³‡æ ¼**: å„åœ‹åœ‹å®¶ä»£è¡¨éšŠæˆ–é ‚ç´šä¿±æ¨‚éƒ¨ï¼Œéœ€æä¾›18äººå®Œæ•´åå–®ã€FIHè¨»å†Šè­‰æ˜åŠå¥åº·æª¢æŸ¥å ±å‘Šã€‚
- **å ±åè²»ç”¨**: å…è²»ã€‚
- **é‡è¦æ—¥æœŸ**: å ±åæˆªæ­¢æ—¥ç‚º 2025/6/30ï¼Œæ–‡ä»¶ç¹³äº¤æˆªæ­¢æ—¥ç‚º 2025/7/15ã€‚
- **åƒè³½å„ªå‹¢**: æä¾›AIé‹å‹•æ•™ç·´å ±å‘Šï¼Œé‹å‹•ç§‘æŠ€é«”é©—ï¼ŒFIHç©åˆ†èªè­‰ç­‰ã€‚

## [è¯çµ¡æ–¹å¼]
- **äººå·¥å®¢æœé›»è©±**: 049-123-4567 (æœå‹™æ™‚é–“: é€±ä¸€è‡³é€±äº” 09:00-18:00)
- **é›»å­éƒµä»¶**: service@nantou-hockey.tw
"""

def call_gemini_api(message):
    """
    èª¿ç”¨çœŸå¯¦çš„Gemini API
    """
    try:
        headers = {
            'Content-Type': 'application/json',
        }
        
        # æ§‹å»ºç³»çµ±æç¤ºè©
        prompt_for_gemini = f"""
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­ã€å‹å–„çš„ã€Œ2025 å—æŠ•åœ‹éš›æ›²æ£çƒé‚€è«‹è³½ã€AIå®¢æœåŠ©æ‰‹ã€‚
        è«‹åš´æ ¼æ ¹æ“šä»¥ä¸‹æä¾›çš„ã€Œåƒè€ƒè³‡æ–™ã€ä¾†å›ç­”ä½¿ç”¨è€…çš„å•é¡Œã€‚
        ä¸è¦ç·¨é€ ä»»ä½•åƒè€ƒè³‡æ–™ä¸­æ²’æœ‰çš„è³‡è¨Šã€‚å¦‚æœç­”æ¡ˆä¸åœ¨è³‡æ–™ä¸­ï¼Œè«‹ç¦®è²Œåœ°è¡¨ç¤ºä¸æ¸…æ¥šæˆ–å¼•å°ä½¿ç”¨è€…è¯ç¹«äººå·¥å®¢æœã€‚
        è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚

        ---
        [åƒè€ƒè³‡æ–™]
        {CONTEXT}
        ---

        [ä½¿ç”¨è€…çš„å•é¡Œ]
        {message}
        """

        payload = {
            "contents": [{"parts": [{"text": prompt_for_gemini}]}],
            "generationConfig": {
                "temperature": 0.7,
                "topK": 40,
                "topP": 0.95,
                "maxOutputTokens": 1024,
            }
        }
        
        # å¦‚æœAPI keyæ˜¯é è¨­å€¼ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡æ“¬å›æ‡‰
        if GEMINI_API_KEY == "XXXX":
            return get_local_response(message)
        
        # èª¿ç”¨çœŸå¯¦çš„Gemini API
        response = requests.post(
            f"{API_URL}?key={API_KEY}",
            headers=headers,
            json=payload,
            timeout=30
        )
        
        if response.status_code == 200:
            result = response.json()
            if 'candidates' in result and len(result['candidates']) > 0:
                content = result['candidates'][0]['content']['parts'][0]['text']
                return {
                    'success': True,
                    'response': content,
                    'source': 'gemini_api'
                }
            else:
                return get_local_response(message)
        else:
            return get_local_response(message)
            
    except Exception as e:
        # å¦‚æœAPIèª¿ç”¨å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å›æ‡‰
        return get_local_response(message)


def get_local_response(message):
    """
    æœ¬åœ°æ¨¡æ“¬å›æ‡‰ï¼Œç•¶Gemini APIä¸å¯ç”¨æ™‚ä½¿ç”¨
    """
    message_lower = message.lower()
    
    if any(keyword in message_lower for keyword in ['æ™‚é–“', 'æ—¥æœŸ', 'è³½ç¨‹']):
        return {
            'success': True,
            'response': '''ğŸ“… **2025å—æŠ•åœ‹éš›ç”·å­æ›²æ£çƒé‚€è«‹è³½**

ğŸ—“ï¸ **è³½äº‹æ™‚é–“ï¼š** 2025å¹´7æœˆ26æ—¥è‡³31æ—¥ï¼ˆå…±6å¤©ï¼‰
â° **æ¯”è³½æ™‚é–“ï¼š** æ¯æ—¥09:00-18:00
ğŸ“ **æ¯”è³½åœ°é»ï¼š** å—æŠ•ç¸£ç«¹å±±é«˜ä¸­æ›²æ£çƒå ´

**è³½ç¨‹å®‰æ’ï¼š**
â€¢ 7/26 (å…­)ï¼šé–‹å¹•å…¸ç¦® + é¦–è¼ªæ¯”è³½
â€¢ 7/27 (æ—¥)ï¼šå°çµ„è³½ç¬¬äºŒè¼ª
â€¢ 7/28 (ä¸€)ï¼šå°çµ„è³½ç¬¬ä¸‰è¼ª  
â€¢ 7/29 (äºŒ)ï¼šæº–æ±ºè³½
â€¢ 7/30 (ä¸‰)ï¼šå­£è»è³½ + å† è»è³½
â€¢ 7/31 (å››)ï¼šé–‰å¹•å…¸ç¦® + é ’ç

éœ€è¦äº†è§£ç‰¹å®šå ´æ¬¡çš„è©³ç´°æ™‚é–“å—ï¼Ÿ''',
            'source': 'local'
        }
    
    elif any(keyword in message_lower for keyword in ['ç¥¨', 'è³¼è²·', 'åƒ¹æ ¼']):
        return {
            'success': True,
            'response': '''ğŸ« **è³¼ç¥¨è³‡è¨Š**

**ç¥¨ç¨®èˆ‡åƒ¹æ ¼ï¼š**
â€¢ **ä¸€èˆ¬ç¥¨ï¼š** NT$500
  - æ‰€æœ‰æ¯”è³½å ´æ¬¡å…¥å ´
  - ä¸€èˆ¬è§€çœ¾å¸­åº§ä½
  - è³½äº‹æ‰‹å†Š

â€¢ **ç²¾ç·»ç¥¨ï¼š** NT$1,200  
  - ç²¾ç·»è§€çœ¾å¸­åº§ä½
  - ARé«”é©—APP
  - ç²¾ç·»é¤ç›’
  - å…è²»åœè»Š

â€¢ **VIPç¥¨ï¼š** NT$2,500
  - VIPå°ˆå±¬åº§ä½
  - å…ƒå®‡å®™è§€è³½é«”é©—
  - é¸æ‰‹è¦‹é¢æœƒ
  - å°ˆå±¬ä¼‘æ¯å®¤

â€¢ **å®¶åº­å¥—ç¥¨ï¼š** NT$1,800
  - 4å¼µä¸€èˆ¬ç¥¨
  - è¦ªå­æ´»å‹•å€
  - å®¶åº­é¤ç›’

**è³¼ç¥¨æ–¹å¼ï¼š** å®˜ç¶²ç·šä¸Šè³¼ç¥¨æˆ–é›»æ´½049-123-4567''',
            'source': 'local'
        }
    
    else:
        return {
            'success': True,
            'response': '''ğŸ‘‹ **æ­¡è¿ä¾†åˆ°å—æŠ•åœ‹éš›æ›²æ£çƒé‚€è«‹è³½ï¼**

æˆ‘æ˜¯æ‚¨çš„AIå®¢æœåŠ©æ‰‹ï¼Œå¯ä»¥å”åŠ©æ‚¨äº†è§£ï¼š

ğŸ« **è³¼ç¥¨è³‡è¨Š** - ç¥¨åƒ¹ã€è³¼ç¥¨æ–¹å¼
ğŸ“… **è³½ç¨‹å®‰æ’** - æ¯”è³½æ™‚é–“ã€å ´æ¬¡
ğŸ“ **äº¤é€šæŒ‡å¼•** - æ¯”è³½åœ°é»ã€äº¤é€šæ–¹å¼  
ğŸŒŸ **è§€å…‰å¥—ç¥¨** - ä½å®¿ã€æ™¯é»å¥—ç¥¨
ğŸš€ **é‹å‹•ç§‘æŠ€** - AIè£åˆ¤ã€å…ƒå®‡å®™è§€è³½
ğŸ† **éšŠä¼å ±å** - åƒè³½è³‡æ ¼ã€å ±åæµç¨‹

è«‹å‘Šè¨´æˆ‘æ‚¨æƒ³äº†è§£ä»€éº¼è³‡è¨Šï¼

å¦‚éœ€äººå·¥å®¢æœï¼š**049-123-4567**''',
            'source': 'local'
        }

@gemini_bp.route('/chat', methods=['POST'])
def gemini_chat():
    """
    ä½¿ç”¨Gemini APIçš„èŠå¤©ç«¯é»
    """
    try:
        data = request.get_json()
        message = data.get('message', '').strip()
        context = data.get('context', '').strip() # æ–°å¢ï¼šæ¥æ”¶ context

        if not message or not context:
            return jsonify({'error': 'ç¼ºå°‘ message æˆ– context'}), 400

        result = call_gemini_api(message, context) # å°‡ message å’Œ context éƒ½å‚³é€²å»
        return jsonify({
            'success': result['success'],
            'response': result['response'],
            'source': result['source'],
            'timestamp': datetime.now().isoformat()
        }), 200
        
    except Exception as e:
        return jsonify({'error': f'è™•ç†è¨Šæ¯å¤±æ•—: {str(e)}'}), 500

@gemini_bp.route('/config', methods=['GET'])
def get_gemini_config():
    """
    ç²å–Geminié…ç½®ç‹€æ…‹
    """
    is_configured = GEMINI_API_KEY != "XXXX"
    
    return jsonify({
        'success': True,
        'configured': is_configured,
        'api_key_set': is_configured,
        'fallback_mode': not is_configured,
        'message': 'Gemini APIå·²é…ç½®' if is_configured else 'Gemini APIæœªé…ç½®ï¼Œä½¿ç”¨æœ¬åœ°å›æ‡‰'
    }), 200

@gemini_bp.route('/config', methods=['POST'])
def update_gemini_config():
    """
    æ›´æ–°Gemini APIé…ç½®ï¼ˆåƒ…ç”¨æ–¼æ¸¬è©¦ï¼Œå¯¦éš›éƒ¨ç½²æ™‚API keyæ‡‰åœ¨ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®šï¼‰
    """
    try:
        data = request.get_json()
        api_key = data.get('api_key', '').strip()
        
        if not api_key:
            return jsonify({'error': 'API keyä¸èƒ½ç‚ºç©º'}), 400
        
        # åœ¨å¯¦éš›éƒ¨ç½²ä¸­ï¼Œé€™æ‡‰è©²é€šéç’°å¢ƒè®Šæ•¸è¨­å®š
        global GEMINI_API_KEY
        GEMINI_API_KEY = api_key
        
        return jsonify({
            'success': True,
            'message': 'Gemini APIé…ç½®å·²æ›´æ–°',
            'configured': True
        }), 200
        
    except Exception as e:
        return jsonify({'error': f'é…ç½®æ›´æ–°å¤±æ•—: {str(e)}'}), 500

